---
# Provision an accounts instance using tutor-deployment,
# but adjust the configuration slightly to use a local smtp
# rather than Amazon SES.

- name: "*slaps ansible with a fish* Use THIS python interpreter!"
  hosts: local
  tasks:
    - when: "'VIRTUAL_ENV' in ansible_env"
      # This assumes that python was Homebrew installed.
      set_fact:
        ansible_python_interpreter: "{{ ansible_env.VIRTUAL_ENV }}/bin/python"

# FIXME tutor-deployment doesn't seem to work with ansible>=2.0.0
- name: setup a virtualenv for tutor-deployment
  hosts: local
  tasks:
    - pip:
        requirements: "{{ source_dir }}/tutor-deployment/requirements.txt"
        virtualenv: "{{ source_dir }}/tutor-deployment"

- name: generate a self-signed certificate
  hosts: local
  vars:
    cert_password: "password"
    cert_domain: "accounts.local.openstax.org"
    cert_dir: "{{ source_dir }}/tutor-deployment/environments/local-accounts-vm/secrets/certs/ost"
    cert_crt_filepath: "{{ cert_dir }}/ost.crt"
    cert_key_filepath: "{{ cert_dir }}/ost.key"
  tasks:
    - file:
        path: "{{ cert_dir }}"
        state: directory
    - stat: path="{{ cert_crt_filepath }}"
      register: crt_file
    - include: tasks/create_self_signed_cert.yml
      when: not crt_file.stat.exists

- name: install tutor-deployment
  hosts: local
  tasks:
    - name: checkout tutor-deployment
      git:
        # FIXME Use the commented out source after this feature gets merged
        # repo: git@github.com:openstax/tutor-deployment.git
        repo: git@github.com:pumazi/tutor-deployment.git
        dest: "{{ source_dir }}/tutor-deployment"
        # version: HEAD
        version: local-accounts-vm
    - name: checkout accounts
      git:
        repo: git@github.com:openstax/accounts.git
        dest: "{{ source_dir }}/accounts"
        version: HEAD
    # There doesn't seem to be a good reason to create a personal virtualenv
    # for this, so let's just use this environment.
    - name: install tutor-deployment
      command: bin/ansible-playbook -vvv -i environments/local-accounts-vm/inventory accounts_only.yml
      args:
        chdir: "{{ source_dir }}/tutor-deployment"

# - name: customize the accounts server
#     - include: tasks/install_supervisor
#     - name: setup local smtp service
#     - name: configure smtp service as a supervisor job
#     - name: start smtp service
#     - name: adjust accounts configuration
#     - name: restart accounts
