#!/bin/bash

zodb_host=$1

backup_ssh_key=~backup/.ssh/${zodb_host}_id_rsa

source=/var/lib/cnx/cnx-buildout/var/filestorage/Data.fs

backup_dir=/var/backups/cnx-backups
zodb_dump_base_name=cnx-$zodb_host-Data.fs.$(date +%y-%m-%d)
zodb_dump_filename=$backup_dir/$zodb_dump_base_name

rsync -e "sudo -u backup ssh -i $backup_ssh_key" -a "backup@$zodb_host:$source" "$zodb_dump_filename"

# save a copy on Amazon AWS S3
/usr/bin/s3cmd put "$zodb_dump_filename" "s3://connexions/backups/$zodb_host/zodb/$zodb_dump_base_name"
