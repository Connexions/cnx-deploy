---
# Configures SSL sites for archive and webview nginx sites.

- name: ensure the ssl directories exists
  when: ansible_os_family == "Darwin"
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ root_prefix }}/etc/ssl/certs"
    - "{{ root_prefix }}/etc/ssl/private"

- name: install certificate pem
  become: "{{ ansible_os_family != 'Darwin' and 'yes' or 'no' }}"
  copy:
    src: "{{ cert_crt_filepath }}"
    dest: "{{ root_prefix }}/etc/ssl/certs/cnx.pem"

- name: install certificate key
  become: "{{ ansible_os_family != 'Darwin' and 'yes' or 'no' }}"
  copy:
    src: "{{ cert_key_filepath }}"
    dest: "{{ root_prefix }}/etc/ssl/private/cnx.key"

- name: install nginx site
  become: "{{ ansible_os_family != 'Darwin' and 'yes' or 'no' }}"
  template:
    src: "etc/nginx/sites-available/ssl"
    dest: "{{ root_prefix }}/etc/nginx/sites-available/ssl"

- name: configure ssl (on Debian)
  # FIXME This should also work for Darwin, but it's not configured to do so.
  # BBB (3-Feb-2016) ubuntu 14.04
  ##when: ansible_os_family == "Debian"
  when: ansible_os_family == "Debian" and ansible_distribution_release != "trusty"
  become: yes
  lineinfile:
    dest: "{{ root_prefix }}/etc/nginx/nginx.conf"
    regexp: "{{ item.regexp }}"
    insertafter: "^[\t]+ssl_prefer_server_ciphers on;"
    line: "{{ item.line }}"
  with_items:
    # - regexp: "^[\t]+ssl_prefer_server_ciphers on;"
    #   line: "\tssl_prefer_server_ciphers on;"
    - regexp: "^[\t]+ssl_session_timeout 5m;"
      line: "\tssl_session_timeout 5m;"
    - regexp: "^[\t]+ssl_ciphers AES256\\+EECDH:AES256\\+EDH;"
      line: "\tssl_ciphers AES256+EECDH:AES256+EDH;"
    - regexp: "^[\t]+ssl_session_cache shared:SSL:10m;"
      line: "\tssl_session_cache shared:SSL:10m;"

# BBB (3-Feb-2016) ubuntu 14.04
- name: configure ssl (on Ubuntu 14.04)
  # FIXME This should also work for Darwin, but it's not configured to do so.
  when: ansible_distribution == "Ubuntu" and ansible_distribution_release == "trusty"
  become: yes
  lineinfile:
    dest: "{{ root_prefix }}/etc/nginx/nginx.conf"
    regexp: "{{ item.regexp }}"
    insertafter: "^[\\t]+include /etc/nginx/sites-enabled/\\*;"
    line: "{{ item.line }}"
  with_items:
    # - regexp: "^[\t]+ssl_prefer_server_ciphers on;"
    #   line: "\tssl_prefer_server_ciphers on;"
    - regexp: "^[\t]+ssl_session_timeout 5m;"
      line: "\tssl_session_timeout 5m;"
    - regexp: "^[\t]+ssl_ciphers AES256\\+EECDH:AES256\\+EDH;"
      line: "\tssl_ciphers AES256+EECDH:AES256+EDH;"
    - regexp: "^[\t]+ssl_session_cache shared:SSL:10m;"
      line: "\tssl_session_cache shared:SSL:10m;"

- name: enable the nginx site
  become: "{{ ansible_os_family != 'Darwin' and 'yes' or 'no' }}"
  file:
    src: "{{ root_prefix }}/etc/nginx/sites-available/ssl"
    dest: "{{ root_prefix }}/etc/nginx/sites-enabled/ssl"
    state: link

# FIXME Doing some/all of this as a role would allow for better restarting of the service.
- name: restart nginx (on Darwin)
  when: ansible_os_family == "Darwin"
  become: yes
  launchd:
    domain: "system"
    label: "homebrew.mxcl.nginx"
    state: restarted

- name: reload nginx (on Debian)
  when: ansible_os_family == "Debian"
  become: yes
  service:
    name: nginx
    state: reloaded
