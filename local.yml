---
# Used to setup a deployment on localhost.
# This should build on both OS X and Debian.

# Note, 'local' (the host name in the inventory)
#   should be assigned ``ansible_connection=local``.

- name: "*slaps osx with a fish*"
  hosts: local
  tasks:
    - when: ansible_os_family == "Darwin"
      # This assumes that python was Homebrew installed.
      set_fact:
        ansible_python_interpreter: /usr/local/bin/python

# +++
# Source gathering
# +++

- name: clone all repositories
  hosts: local
  tasks:
    - include: tasks/checkout.yml

# +++
# Persistence services
# +++

# TODO (mocked) NFS mount

- name: install postgres database
  hosts: local
  tasks:
    - include: tasks/install_postgres.yml
  roles:
    - multimac.launchd

- name: install memcached
  hosts: local
  tasks:
    - include: tasks/install_memcached.yml

# +++
# Applications
# +++

# TODO Prerender

- name: install supervisor
  hosts: local
  vars:
    # FIXME Need to set /usr/local root_prefix for Darwin a few layers up
    root_prefix: "{{ ansible_os_family == 'Darwin' and '/usr/local' or '' }}"
  tasks:
    - include: tasks/install_supervisor.yml

- name: install archive and publishing
  hosts: arclishing
  tasks:
    - include: tasks/install_arclishing.yml

- name: generate a self-signed certificate
  hosts: local
  vars:
    cert_password: "password"
    cert_domain: "*.{{ frontend_domain }}"
    cert_dir: "{{ inventory_dir }}/secrets/certs/cnx"
    cert_crt_filepath: "{{ cert_dir }}/cnx.crt"
    cert_key_filepath: "{{ cert_dir }}/cnx.key"
  tasks:
    - file:
        path: "{{ cert_dir }}"
        state: directory
    - stat: path="{{ cert_crt_filepath }}"
      register: crt_file
    - include: tasks/create_self_signed_cert.yml
      when: not crt_file.stat.exists

- name: build webview
  hosts: local
  tasks:
    - include: tasks/build_webview.yml

- name: install frontend
  hosts: frontend
  vars:
    cert_password: "password"
    cert_domain: "*.{{ frontend_domain }}"
    cert_dir: "{{ inventory_dir }}/secrets/certs/cnx"
    cert_crt_filepath: "{{ cert_dir }}/cnx.crt"
    cert_key_filepath: "{{ cert_dir }}/cnx.key"
  tasks:
    - include: tasks/ensure_shared_fs.yml
    - include: tasks/install_nginx.yml
    - include: tasks/install_varnish.yml
    - include: tasks/install_webview.yml
    - include: tasks/configure_ssl.yml
  roles:
    - multimac.launchd

- name: install authoring
  hosts: authoring
  tasks:
    - include: tasks/install_authoring.yml
  roles:
    - multimac.launchd
